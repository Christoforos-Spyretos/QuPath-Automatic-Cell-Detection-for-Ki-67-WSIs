# Automatic Quantification of Ki-67 Labeling Index in Pediatric Brain Tumors Using QuPath

This repository includes an Apache Groovy script (Java-based syntax) for automated Ki-67 LI scoring, along with a Python script for post-processing to generate summary tables and graphical representations of the Ki-67 scores, and visualize density maps.

[Preprint]() | [Cite](#reference)

### Abstract
The quantification of the Ki-67 labeling index (LI) is critical for assessing tumor proliferation and prognosis in tumors, yet manual scoring remains a common practice. This study presents an automated workflow for Ki-67 scoring in whole slide images (WSIs) using an Apache Groovy code script for QuPath, complemented by a Python-based post-processing script, providing cell density maps and summary tables. The tissue and cell segmentation are performed using StarDist, a deep learning model, and adaptive thresholding to classify Ki-67 positive and negative nuclei. The pipeline was applied to a cohort of 632 pediatric brain tumor cases with 734 Ki-67-stained WSIs from the Children's Brain Tumor Network. Medulloblastoma showed the highest Ki-67 LI (median: 19.84, mean: 23.10 ± 16.15, maximum: 68.75), followed by atypical teratoid rhabdoid tumor (median: 19.36, mean: 20.48 ± 11.20). Moderate values were observed in brainstem glioma-diffuse intrinsic pontine glioma (median: 11.50), high-grade glioma (grades 3 & 4) (median: 9.50), and ependymoma (median: 5.88). Lower indices were found in meningioma (median: 1.84, mean: 3.37 ± 3.92), while the lowest were seen in low-grade glioma (grades 1 & 2) (median: 0.85), dysembryoplastic neuroepithelial tumor (median: 0.63), and ganglioglioma (median: 0.50). The results aligned with the consensus of the oncology, demonstrating a significant correlation in Ki-67 LI across most of the tumor families/types, with high malignancy tumors showing the highest proliferation indices and lower malignancy tumors exhibiting lower Ki-67 LI. The automated approach facilitates the assessment of large amounts of Ki-67 WSIs and offers adaptability for other immunohistochemical markers in research settings. 

## Table of Contents
- [Setup](#Setup)
- [Apache Groovy Script](#groovy)
- [Post Processing Python Script](#post-processing)
- [Reference](#reference)
- [License](#license)
---

## Setup

1. Install QuPath
Begin by downloading and installing QuPath, an open-source software platform for digital pathology image analysis, from the official website:

First download QuPath [QuPath](https://qupath.github.io)

2. Clone the Repository
Next, clone the Git repository that contains the analysis scripts. Follow GitHub’s official instructions here: [clone a GitHub repository](https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository)


3. Create a Project Folder
Inside the cloned directory, create a new folder to serve as your QuPath project workspace. For example, name it Ki-67 Project.

4. Prepare Metadata
Create a `.csv` file with the following headers:
- `case_id`: Unique identifier for each patient or case
- `slide_id`: Identifier for the whole slide image
- `label`: Optional label used for grouping or classification (e.g., tumor type)

Here is an example of how the `.csv` should look like:
| case_id   | slide_id   | label   |
|-----------|------------|---------|
| case_001  | slide_001  | label_1 |
| case_002  | slide_002  | label_2 |
| case_003  | slide_003  | label_3 |

## Apache Groovy Script

Open QuPath

## Post Processing Python Script

To run the post-processing Python script, open a terminal window, navigate to the directory containing all relevant files and folders, then execute the following command:
```bash
python summary_ratios.py --maps_dir MAPS_DIRECTORY --data_dir PROJECT_DATA_DIRECTORY--csv_path PATH_to_CSV --WSIs_dir WSI_DIRECTORY --norm_maps_dir NORM_MAPS_DIRECTORY --result_dir RESULT_DIRECTORY
```

### Arguments:
- `--maps_dir`: Directory of the cell density maps generated by QuPath.
- `--data_dir`: Directory of the project data.
- `--csv_path`: Path to the WSI dataframe CSV file (required).
- `--WSIs_dir`: Directory of the folder where the WSIs exist.
- `--norm_maps_dir`: Directory to save the normalized cell density maps.
- `--result_dir`: Directory to save the summary tables and graphs.

## Reference

## License
This work is licensed under [Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International](https://creativecommons.org/licenses/by-nc-sa/4.0/).